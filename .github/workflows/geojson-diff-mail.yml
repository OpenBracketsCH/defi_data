name: GeoJSON Diff Mail

on:
  push:
    paths:
      - data/json/defis_kt_be.geojson
    branches:
      - main

jobs:
  diff-and-mail:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # komplette Historie nötig für vorherigen Commit

      # 2️⃣ Python installieren
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3️⃣ Vorherigen Commit der GeoJSON-Datei ermitteln
      - name: Ermitteln des vorherigen Commits
        id: prev_commit
        run: |
          PREV=$(git log -n 2 --pretty=format:"%H" -- data/json/defis_kt_be.geojson | tail -n1)
          echo "PREV=$PREV" >> $GITHUB_ENV

      # 4️⃣ Diff HTML erstellen
      - name: Diff HTML erstellen
        run: |
          python scripts/geojson_diff.py \
            <(git show $PREV:data/json/defis_kt_be.geojson) \
            data/json/defis_kt_be.geojson \
            > diff.html

      # 5️⃣ Mail versenden
      - name: Mail versenden
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: asmtp.mail.hostpoint.ch
          server_port: 587
          secure: false
          username: ${{ secrets.MAIL_USER }}
          password: ${{ secrets.MAIL_PASS }}
          subject: "Änderungen an Defis Kanton Bern"
          html_body: file://diff.html
          to: reports@defikarte.ch
          from: Defikarte.ch Reporting
